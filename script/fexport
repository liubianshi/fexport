#!/usr/bin/env perl
# vim: set ft=perl nowrap fdm=marker

use v5.20;
use strict;
use warnings;
use utf8;

# --- Core Dependencies ---
use Path::Tiny;
use Getopt::Long     qw(:config bundling);
use List::Util       qw(any);
use Cwd              qw(getcwd abs_path);
use Encode           qw(encode_utf8 decode_utf8);
use POSIX            qw(setsid);
use Text::ParseWords qw(shellwords);

use Term::ANSIColor qw(:constants);
$Term::ANSIColor::AUTORESET = 1;

# --- Fexport Modules ---
# å¼•å…¥ Config æ¨¡å—ä¸­çš„æ ¸å¿ƒå‡½æ•°
use Fexport::Config      qw(load_config merge_config process_params);
use Fexport::Util        qw(run_pandoc save_lines stop_browser_preview);
use Fexport::PostProcess qw(postprocess_docx postprocess_html postprocess_latex);
use Fexport::Rmd         qw(render_rmd);
use Fexport::Quarto      qw(render_qmd);
use Fexport::Pandoc      qw(build_cmd);
use Fexport::Converter   qw(convert);

# --- Global Cleanup Handling ---
my @temp_files;
$SIG{INT} = $SIG{TERM} = sub {
  path($_)->remove for @temp_files;
  exit 1;
};

# ==============================================================================
# Configuration Parsing and Merging Module
# ==============================================================================

# Purpose: Parse command-line arguments and merge configuration from multiple
# sources (defaults, config file, CLI arguments) with proper precedence handling.

# ------------------------------------------------------------------------------
# 1. å‚æ•°è§£æä¸é…ç½®åˆå¹¶
# ------------------------------------------------------------------------------
# Separates CLI arguments into two categories:
# - Arguments before '--' are processed by GetOptions
# - Arguments after '--' are stored in @passthrough_args for forwarding
# Decode command line arguments to internal character strings
@ARGV = map { decode_utf8($_) } @ARGV;

my @passthrough_args;

# Locate the '--' separator using grep (idiomatic Perl approach)
my ($sep_index) = grep { $ARGV[$_] eq '--' } 0 .. $#ARGV;

if ( defined $sep_index ) {
  @passthrough_args = splice( @ARGV, $sep_index + 1 );    # Extract pass-through arguments and remove them from @ARGV
  pop @ARGV;                                              # Remove the '--' separator itself
}

# ------------------------------------------------------------------------------
# Parse Command-Line Options
# ------------------------------------------------------------------------------
# Configure Getopt::Long for flexible argument handling:
# - bundling: Allow combining single-letter options (-vk)
# - pass_through: Allow unrecognized options to remain in @ARGV
my %cli;
Getopt::Long::Configure( 'bundling', 'pass_through' );

GetOptions(
  'from|f=s'     => \$cli{from},               # specify source file
  'to|t=s'       => \$cli{to},                 # specify destination file
  'outfile|o=s'  => \$cli{outfile},            # output file path
  'workdir=s'    => \$cli{workdir},            # working directory
  'outdir|d=s'   => \$cli{outdir},             # output directory
  'config|c=s'   => \$cli{config},             # configuration file
  'keep|k'       => \$cli{keep},               # keep intermediate files
  'preview'      => \$cli{preview},            # enable preview mode
  'stop-preview' => \$cli{stop_preview},       # stop preview mode
  'browser=s'    => \$cli{browser},            # browser to use
  'open'         => \$cli{open},               # open in browser
  'lang=s'       => \$cli{lang},               # language setting
  'verbose|v'    => \$cli{verbose},            # enable verbose output
  'help|h'       => sub { help(); exit 0 },    # show help and exit
  )
  or die "Error: Failed to parse command-line arguments. Use --help for usage.\n";

# ------------------------------------------------------------------------------
# Handle Special Actions
# ------------------------------------------------------------------------------
# Process --stop-preview flag immediately if specified
if ( $cli{stop_preview} ) {
  stop_browser_preview();
  exit 0;
}

# ------------------------------------------------------------------------------
# Load and Merge Configuration
# ------------------------------------------------------------------------------
# Configuration precedence (highest to lowest):
# 1. Command-line arguments (CLI)
# 2. Configuration file
# 3. Default values
#
# Delegated to: Fexport::Config::merge_config
my $file_config = load_config( $cli{config} );

# ------------------------------------------------------------------------------
# Validate Input Files
# ------------------------------------------------------------------------------
# The remaining items in @ARGV are treated as input files
my @input_files = @ARGV;

# Enforce single input file constraint
if ( @input_files > 1 ) {
  die "Error: Multiple input files detected (" . join( ', ', @input_files ) . "). Only one input file is allowed.\n";
}

# Note: At this point, if @input_files is empty, it may be handled elsewhere
# or default input behavior may apply depending on the application design.

my $infile_raw = $input_files[0];
my $cwd_raw    = decode_utf8(getcwd());

# Use passthrough_args as pandoc_opts
$cli{pandoc_opts} = \@passthrough_args;

my $opts = merge_config( $file_config, \%cli );

# B. è·¯å¾„è§£æä¸å‚æ•°æ¨æ–­
# é€»è¾‘ç§»äº¤: Fexport::Config::process_params å¤„ç†äº†æ‰€æœ‰å¤æ‚çš„è·¯å¾„è®¡ç®—ã€æ ¼å¼æ¨æ–­

# process_params è¿”å›: (å·¥ä½œç›®å½•, ç»å¯¹è¾“å…¥è·¯å¾„, ç»å¯¹è¾“å‡ºè·¯å¾„)
# æ³¨æ„: è¿™é‡Œå‡è®¾ä½ é‡‡çº³äº† Config æ¨¡å—è¿”å›ç»å¯¹è·¯å¾„çš„å»ºè®®ã€‚
# å¦‚æœ Config ä»è¿”å›ç›¸å¯¹è·¯å¾„ï¼Œä¸‹é¢éœ€è¦ç”¨ $workdir->child() åŒ…è£…ä¸€ä¸‹ã€‚
my ( $work_dir_str, $infile_str, $outfile_str ) = process_params( $opts, $infile_raw, $cwd_raw );

# è½¬æ¢ä¸ºå¯¹è±¡ä»¥ä¾¿åç»­æ“ä½œ
my $workdir = path($work_dir_str);
my $outfile = path($outfile_str);
my $infile  = defined $infile_str ? path($infile_str) : undef;

# æ­¤æ—¶ $opts->{from}, $opts->{to} å·²ç»è¢« process_params å¡«å……æˆ–æ¨æ–­å®Œæ¯•

# åˆ‡æ¢å·¥ä½œç›®å½• (å¦‚æœéœ€è¦)
# RMarkdown å’Œ Quarto é€šå¸¸ä¾èµ–ç›¸å¯¹è·¯å¾„èµ„æºï¼Œåˆ‡æ¢ CWD æ˜¯æœ€å®‰å…¨çš„
if ( $workdir->stringify ne path(".")->absolute->stringify ) {
  chdir $workdir;
  say "[Info] Changed CWD to: $workdir" if $opts->{verbose};
}

# ==============================================================================
# 2. æ„å»º Pandoc å‘½ä»¤
# ==============================================================================
# é€»è¾‘ç§»äº¤: Fexport::Pandoc::build_cmd å¤„ç†å‘½ä»¤æ‹¼æ¥
# $opts->{pandoc} åŒ…å«äº†æ¥è‡ªé…ç½®æ–‡ä»¶çš„ filters, cmd ç­‰è®¾ç½®
# $opts->{pandoc_opts} åŒ…å«äº† CLI ä¼ å…¥çš„é¢å¤–å‚æ•°
my @pandoc_cmd = build_cmd(
  $opts->{pandoc},
  {
    from      => $opts->{from},
    verbose   => $opts->{verbose},
    user_opts => $opts->{pandoc_opts}
  }
);

# å‡†å¤‡æ—¥å¿—æ–‡ä»¶
my $log_file = Path::Tiny->tempfile;
my $log_fh   = $log_file->openw;

# ==============================================================================
# 3. å¤„ç†è¾“å…¥æº (Markdown / Rmd / Quarto)
# ==============================================================================
my @md_lines;
my $is_external_done = 0;    # æ ‡è®°æ˜¯å¦ç”±å¤–éƒ¨å·¥å…·ç›´æ¥ç”Ÿæˆäº†æœ€ç»ˆæ–‡ä»¶

if ( $opts->{from} eq 'md' ) {

  # åˆ†æ”¯ A: çº¯ Markdown
  if ($infile) {
    @md_lines = $infile->lines_utf8;
  }
  else {
    # å¤„ç† STDIN è¾“å…¥
    @md_lines = <STDIN>;

    # å¦‚æœæ˜¯ STDINï¼Œprocess_params ä¼šç”Ÿæˆé»˜è®¤ outfile
  }
}
elsif ( $opts->{from} eq 'rmd' ) {

  # åˆ†æ”¯ B: RMarkdown
  unless ($infile) {
    my $tmp = Path::Tiny->tempfile( SUFFIX => '.Rmd' );
    $tmp->spew_utf8(<STDIN>);
    $infile = $tmp;
    push @temp_files, $tmp;
  }

  # è°ƒç”¨ Fexport::Rmd::render_rmd
  # è¿™ä¸€æ­¥å¯èƒ½ä¼šäº§ç”Ÿä¸­é—´ Markdownï¼Œä¹Ÿå¯èƒ½ç›´æ¥ç”Ÿæˆ PDF/Docx
  my $res = render_rmd( $infile, $opts->{to}, \@pandoc_cmd );

  # æ³¨å†Œéœ€è¦æ¸…ç†çš„ä¸­é—´æ–‡ä»¶
  if ( $res->{clean_files} ) {
    push @temp_files, @{ $res->{clean_files} };
  }

  if ( $res->{md_lines} && @{ $res->{md_lines} } ) {

    # æƒ…å†µ 1: R ç”Ÿæˆäº†ä¸­é—´ Markdownï¼Œéœ€è¦ Perl ç»§ç»­è·‘ Pandoc
    @md_lines = @{ $res->{md_lines} };
  }
  else {
    # æƒ…å†µ 2: R ç›´æ¥ç”Ÿæˆäº†æœ€ç»ˆæ–‡ä»¶
    # æ£€æŸ¥ R çš„è¾“å‡ºè·¯å¾„ä¸æˆ‘ä»¬çš„é¢„æœŸè·¯å¾„æ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™ç§»åŠ¨
    my $r_out = $res->{meta}{outfile};
    if ($r_out) {
      my $r_out_path = path($r_out)->absolute;    # R äº§ç”Ÿçš„è·¯å¾„é€šå¸¸ç›¸å¯¹äº workdir
      if ( $r_out_path ne $outfile ) {
        if ( $r_out_path->exists ) {
          $r_out_path->move($outfile);
        }
        else {
          warn "[Warn] R reported outfile '$r_out' but it does not exist.\n";
        }
      }
    }
    $is_external_done = 1;
  }
}
elsif ( $opts->{from} =~ /^(qmd|quarto)$/ ) {

  # åˆ†æ”¯ C: Quarto
  render_qmd(
    {
      infile  => $infile,
      to      => $opts->{to},
      outfile => $outfile,
      lang    => $opts->{lang},
      preview => $opts->{preview},
      verbose => $opts->{verbose},
      keep    => $opts->{keep},
      browser => $opts->{browser},
    }
  );
  $is_external_done = 1;
}
else {
  die "Error: Unsupported input format '$opts->{from}'\n";
}

# ==============================================================================
# 4. è½¬æ¢ä¸åå¤„ç† (Conversion & Post-Processing)
# ==============================================================================

if ($is_external_done) {

  # å¦‚æœå¤–éƒ¨å·¥å…·å·²å®Œæˆç”Ÿæˆï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é¢å¤–çš„ Perl åå¤„ç†
  # ä¾‹å¦‚ï¼šRMarkdown ç”Ÿæˆçš„ Docx å¯èƒ½ä»éœ€è¦ CJK ä¼˜åŒ–
  if ( $opts->{to} eq 'docx' && $opts->{from} eq 'rmd' ) {
    postprocess_docx($outfile);
  }

  # Quarto æ¨¡å—å†…éƒ¨å·²åŒ…å«åå¤„ç†é€»è¾‘ï¼Œæ­¤å¤„ç•¥è¿‡
}
else {
  # æ ‡å‡† Pandoc è½¬æ¢æµç¨‹
  convert(
    {
      format      => $opts->{to},
      outfile     => $outfile->stringify,
      md_contents => \@md_lines,
      pandoc      => \@pandoc_cmd,
      log_fh      => $log_fh,
      verbose     => $opts->{verbose},
      keep        => $opts->{keep},
      preview     => $opts->{preview},      # Browser-Sync é¢„è§ˆ
      browser     => $opts->{browser},      # æŒ‡å®šæµè§ˆå™¨
      lang        => $opts->{lang}
    }
  );
}

# ==============================================================================
# 5. æ”¶å°¾å·¥ä½œ
# ==============================================================================

# è¾“å‡ºæ—¥å¿—
if ( $opts->{verbose} ) {
  close $log_fh;
  print $_ for $log_file->lines;
}

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
unless ( $opts->{keep} ) {
  path($_)->remove for @temp_files;
}

# è¾“å‡ºæœ€ç»ˆç»“æœè·¯å¾„
# outfile æ˜¯ç›¸å¯¹äº workdir çš„ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è¿˜åŸä¸ºç›¸å¯¹äºåˆå§‹æ‰§è¡Œç›®å½•($cwd_raw)çš„è·¯å¾„
my $final_out =
    $outfile->is_absolute
  ? $outfile
  : $workdir->child($outfile);

# ä½¿ç”¨ realpath è§£æç¬¦å·é“¾æ¥å’Œ .. (æ³¨æ„: realpath éœ€è¦æ–‡ä»¶å­˜åœ¨ï¼Œè¿™é‡Œå·²ç»ç”Ÿæˆäº†ï¼Œæ‰€ä»¥æ²¡é—®é¢˜)
# å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨( dry run?), åˆ™ fallback åˆ° stringify
my $clean_path = $final_out->exists ? $final_out->realpath : $final_out->absolute;

# è½¬ä¸ºç›¸å¯¹äºåŸå§‹ CWD çš„è·¯å¾„ (ä»…å½“åœ¨å½“å‰ç›®å½•ä¸‹æ—¶æ˜¾ç¤ºç›¸å¯¹è·¯å¾„)
my $display_out =
    path($cwd_raw)->subsumes($clean_path)
  ? $clean_path->relative($cwd_raw)
  : $clean_path->absolute;

say encode_utf8( "\n" . BOLD . GREEN . "ğŸ‰ Exported: " . $display_out . RESET );

if ( $opts->{open} ) {
  my $sys = $^O;
  my $cmd;

  if    ( $sys eq 'linux' )   { $cmd = 'xdg-open' }
  elsif ( $sys eq 'darwin' )  { $cmd = 'open' }
  elsif ( $sys eq 'MSWin32' ) { $cmd = 'start' }

  if ($cmd) {

    # Detach and run
    defined( my $pid = fork ) or die "Can't fork: $!";
    if ( $pid == 0 ) {

      # Child process
      defined( my $grandchild_pid = fork ) or die "Can't fork: $!";
      if ( $grandchild_pid == 0 ) {

        # Grandchild process
        setsid() or die "Can't start a new session: $!";
        open STDIN,  '<', '/dev/null';
        open STDOUT, '>', '/dev/null';
        open STDERR, '>', '/dev/null';
        exec $cmd, $clean_path or die "Can't exec $cmd: $!";
      }
      else {
        # Child exits immediately
        exit 0;
      }
    }
    else {
      # Parent process
      waitpid( $pid, 0 );    # Wait for the first child to exit
      say encode_utf8( BOLD . YELLOW . "ğŸš€ Opening:  " . RESET . $display_out . " (" . $cmd . ")" );
    }
  }
  else {
    warn "[Warn] Don't know how to open files on this OS ($sys).\n";
  }
}

exit 0;

sub help {
  require Pod::Usage;
  Pod::Usage::pod2usage( -verbose => 2 );
}
__END__

=encoding utf8

=head1 NAME

fexport - æ–‡æ¡£è½¬æ¢å·¥å…·ï¼Œæ”¯æŒ Markdownã€RMarkdownã€Quarto è½¬æ¢ä¸ºå¤šç§æ ¼å¼

=head1 SYNOPSIS

    fexport [é€‰é¡¹] [è¾“å…¥æ–‡ä»¶]

    # åŸºæœ¬ç”¨æ³•
    fexport input.md                      # è½¬æ¢ä¸º HTML (é»˜è®¤)
    fexport -t pdf input.md               # è½¬æ¢ä¸º PDF
    fexport -t docx -o report.docx doc.md # è½¬æ¢ä¸º Word æ–‡æ¡£

    # é¢„è§ˆåŠŸèƒ½
    fexport --preview -t html input.md    # è½¬æ¢å¹¶å¯åŠ¨å®æ—¶é¢„è§ˆ
    fexport --stop-preview                # åœæ­¢æ‰€æœ‰é¢„è§ˆæœåŠ¡å™¨

    # è¾“å‡ºç›®å½•æ§åˆ¶
    fexport -t pdf -d ./output input.md   # è¾“å‡ºåˆ°æŒ‡å®šç›®å½•

    # é«˜çº§ç”¨æ³•
    fexport -t pdf -c myconfig.yaml -v input.md  # ä½¿ç”¨é…ç½®æ–‡ä»¶å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯

=head1 DESCRIPTION

fexport æ˜¯ä¸€ä¸ªæ–‡æ¡£è½¬æ¢å·¥å…·ï¼ŒåŸºäº Pandoc å®ç°ï¼Œæ”¯æŒå°† Markdownã€RMarkdown å’Œ
Quarto æ–‡æ¡£è½¬æ¢ä¸º HTMLã€PDFã€Word ç­‰å¤šç§æ ¼å¼ã€‚

ä¸»è¦ç‰¹æ€§ï¼š

=over 4

=item * B<æ ¼å¼è‡ªåŠ¨æ£€æµ‹>: æ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨è¯†åˆ«è¾“å…¥æ ¼å¼

=item * B<å®æ—¶é¢„è§ˆ>: ä½¿ç”¨ browser-sync å®ç° HTML æ–‡æ¡£çš„å®æ—¶é¢„è§ˆå’Œè‡ªåŠ¨åˆ·æ–°

=item * B<é…ç½®çµæ´»>: æ”¯æŒ YAML é…ç½®æ–‡ä»¶å’Œå‘½ä»¤è¡Œé€‰é¡¹

=item * B<æ™ºèƒ½è·¯å¾„å¤„ç†>: ç»å¯¹è·¯å¾„ä½¿ç”¨æ–‡ä»¶ç›®å½•ï¼Œç›¸å¯¹è·¯å¾„ä½¿ç”¨å½“å‰ç›®å½•

=back

=head1 OPTIONS

=head2 åŸºæœ¬é€‰é¡¹

=over 8

=item B<--to, -t> I<FORMAT>

æŒ‡å®šè¾“å‡ºæ ¼å¼ã€‚æ”¯æŒçš„æ ¼å¼åŒ…æ‹¬ï¼š

    html   - HTML ç½‘é¡µ (é»˜è®¤)
    pdf    - PDF æ–‡æ¡£ (éœ€è¦ LaTeX)
    docx   - Microsoft Word æ–‡æ¡£
    latex  - LaTeX æºæ–‡ä»¶
    å…¶ä»–   - Pandoc æ”¯æŒçš„ä»»æ„æ ¼å¼

=item B<--from, -f> I<FORMAT>

æŒ‡å®šè¾“å…¥æ ¼å¼ã€‚é€šå¸¸ä¼šæ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨æ£€æµ‹ï¼š

    md, markdown  - Markdown
    rmd           - RMarkdown (éœ€è¦ R)
    qmd, quarto   - Quarto

=item B<--outfile, -o> I<FILE>

æŒ‡å®šè¾“å‡ºæ–‡ä»¶åã€‚å¦‚æœªæŒ‡å®šï¼Œå°†ä½¿ç”¨è¾“å…¥æ–‡ä»¶åå¹¶æ›¿æ¢ä¸ºå¯¹åº”æ‰©å±•åã€‚

=item B<--outdir, -d> I<DIR>

æŒ‡å®šè¾“å‡ºç›®å½•ã€‚æ–‡ä»¶å°†è¾“å‡ºåˆ°æ­¤ç›®å½•ä¸‹ã€‚

=item B<--workdir> I<DIR>

æ˜¾å¼æŒ‡å®šå·¥ä½œç›®å½•ã€‚é»˜è®¤è¡Œä¸ºï¼š

    - è¾“å…¥æ–‡ä»¶æ˜¯ç»å¯¹è·¯å¾„ï¼šä½¿ç”¨æ–‡ä»¶æ‰€åœ¨ç›®å½•
    - è¾“å…¥æ–‡ä»¶æ˜¯ç›¸å¯¹è·¯å¾„ï¼šä½¿ç”¨å½“å‰ç›®å½•

=back

=head2 é…ç½®é€‰é¡¹

=over 8

=item B<--config, -c> I<FILE>

æŒ‡å®š YAML é…ç½®æ–‡ä»¶ã€‚é…ç½®æ–‡ä»¶å¯ä»¥è®¾ç½®é»˜è®¤é€‰é¡¹å’Œ Pandoc å‚æ•°ã€‚

å¦‚æœä¸æŒ‡å®šï¼Œç¨‹åºä¼šè‡ªåŠ¨æœç´¢ä»¥ä¸‹ä½ç½®çš„é…ç½®æ–‡ä»¶ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š

    1. $XDG_CONFIG_HOME/fexport/config.yaml (é»˜è®¤ ~/.config/fexport/config.yaml)
    2. ~/.fexport.yaml (å‘åå…¼å®¹)

=item B<-->

ä¼ é€’é¢å¤–é€‰é¡¹ç»™ Pandocã€‚åœ¨ C<--> ä¹‹åçš„æ‰€æœ‰å‚æ•°å°†ç›´æ¥ä¼ ç»™ Pandocã€‚ä¾‹å¦‚ï¼š

    fexport -t pdf input.md -- -V geometry:margin=1in
    fexport -t html input.md -- --toc --toc-depth=2

=item B<--lang> I<LANG>

æŒ‡å®šæ–‡æ¡£è¯­è¨€ï¼Œå¦‚ C<zh>ï¼ˆä¸­æ–‡ï¼‰æˆ– C<en>ï¼ˆè‹±æ–‡ï¼‰ã€‚

=back

=head2 è¡Œä¸ºæ§åˆ¶

=over 8

=item B<--verbose, -v>

å¯ç”¨è¯¦ç»†è¾“å‡ºæ¨¡å¼ï¼Œæ˜¾ç¤º Pandoc æ‰§è¡Œè¿‡ç¨‹å’Œè¯¦ç»†æ—¥å¿—ã€‚

=item B<--keep, -k>

ä¿ç•™ä¸­é—´æ–‡ä»¶ã€‚å¯¹äº PDF è¾“å‡ºï¼Œå°†ä¿ç•™ .tex æ–‡ä»¶å’Œç¼–è¯‘ç›®å½•ä»¥ä¾¿è°ƒè¯•ã€‚

=back

=head2 é¢„è§ˆåŠŸèƒ½

=over 8

=item B<--preview>

å¯ç”¨ HTML æ–‡æ¡£çš„å®æ—¶é¢„è§ˆåŠŸèƒ½ã€‚éœ€è¦å®‰è£… browser-syncï¼š

    npm install -g browser-sync

å¯ç”¨åï¼Œä¿®æ”¹æºæ–‡ä»¶å¹¶é‡æ–°è¿è¡Œ fexportï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨åˆ·æ–°ã€‚

=item B<--stop-preview>

åœæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„é¢„è§ˆæœåŠ¡å™¨ã€‚

=item B<--browser> I<COMMAND>

æŒ‡å®šç”¨äºé¢„è§ˆçš„æµè§ˆå™¨å‘½ä»¤ã€‚ä¾‹å¦‚ï¼š

    fexport --preview --browser=firefox -t html input.md
    fexport --preview --browser=google-chrome -t html input.md

=item B<--open>

è‡ªåŠ¨æ‰“å¼€ç”Ÿæˆçš„æ–‡ä»¶ã€‚

    fexport --open input.md

=back

=head2 å¸®åŠ©

=over 8

=item B<--help, -h>

æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ã€‚

=back

=head1 EXAMPLES

=head2 åŸºæœ¬è½¬æ¢

    # Markdown è½¬ HTML
    fexport document.md

    # Markdown è½¬ PDF
    fexport -t pdf document.md

    # Markdown è½¬ Word
    fexport -t docx -o report.docx document.md

=head2 RMarkdown å’Œ Quarto

    # RMarkdown è½¬ HTML
    fexport analysis.Rmd

    # Quarto è½¬ PDF
    fexport -t pdf paper.qmd

=head2 ä½¿ç”¨é¢„è§ˆ

    # å¯åŠ¨é¢„è§ˆ
    fexport --preview document.md

    # ä¿®æ”¹æ–‡æ¡£åï¼Œé‡æ–°è½¬æ¢ï¼ˆæµè§ˆå™¨è‡ªåŠ¨åˆ·æ–°ï¼‰
    fexport document.md

    # å®Œæˆååœæ­¢é¢„è§ˆæœåŠ¡å™¨
    fexport --stop-preview

=head2 æ‰¹é‡å¤„ç†

    # é…åˆ shell å¾ªç¯ä½¿ç”¨
    for f in *.md; do fexport -t pdf -d ./pdf "$f"; done

=head1 CONFIGURATION

å¯ä»¥åˆ›å»º YAML é…ç½®æ–‡ä»¶æ¥è‡ªå®šä¹‰é»˜è®¤è¡Œä¸ºã€‚ç¤ºä¾‹é…ç½®ï¼š

    # ~/.fexport.yaml
    to: pdf
    lang: zh
    pandoc:
      cmd: "pandoc +RTS -M512M -RTS"
      filters:
        - "--citeproc"
        - "--lua-filter=my-filter.lua"
      user-opts:
        - "-V"
        - "geometry:margin=1in"

ä½¿ç”¨ï¼šC<fexport -c ~/.fexport.yaml input.md>

=head1 FILES

=over 4

=item F<~/.config/fexport/config.yaml>

ç”¨æˆ·é…ç½®æ–‡ä»¶ (XDG è§„èŒƒä½ç½®)

=item F<~/.fexport.yaml>

ç”¨æˆ·é…ç½®æ–‡ä»¶ (å‘åå…¼å®¹ä½ç½®)

=item F<share/defaults.yaml>

å†…ç½®é»˜è®¤é…ç½®æ–‡ä»¶

=item F</tmp/fexport-state/>

é¢„è§ˆæœåŠ¡å™¨çŠ¶æ€ç›®å½•

=back

=head1 SEE ALSO

L<pandoc(1)>, L<quarto(1)>

=head1 AUTHOR

fexport contributors

=cut
